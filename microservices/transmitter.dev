const passport = require('./passport')
const WebSocket = require('ws')
const wss = new WebSocket.Server({port: 8118})
const router = require('./router')

const broadcast = data => {
    wss.clients.forEach(client => {
        client.readyState === WebSocket.OPEN ? client.send(data) : null
    })
}

const activeClients = () => {
    let result = []
    wss.clients.forEach(client => client.readyState === 1 ? result.push(client) : null)
    return result
}

const checkToInternalFunction = ({message, ws}) => {
    try {
        let frame = JSON.parse(message)
        console.log('Requested internal function')
        console.log(frame)
        let responseFrame
        switch (frame.type) {
            case 'request_get_active_clients':
                responseFrame = {
                    type: 'set_active_clients',
                    model: activeClients()
                }
                if (frame.request) {
                    responseFrame.response = {
                        id: frame.request.id
                    }
                }
                console.log('Response: ', responseFrame)
                ws && ws.readyState === WebSocket.OPEN ? ws.send(JSON.stringify(responseFrame)) : null
                break
            default: break
        }
    } catch (e) {
        throw Error('Ошибка выполнения внутренней инструкции сервера WebSocket: ', e)
    }
}

wss.on('connection', (ws, req) => {
    const parseCookie = str => {
        return {
            key: str.split('=')[0],
            value: str.split('=')[1]
        }
    }
    if (!req || !req.headers || !req.headers.cookie) {
        ws.send('Access denied')
        ws.close()
    } else {
        let cookies = req.headers.cookie.split(';')
        cookies = cookies.map(item => parseCookie(item))
        !passport.verifyToken(cookies) ? ws.close() : console.log('Connected from: ' + req.socket.remoteAddress)
    }

    ws.on('message', message => {
        console.log(`Received message => ${message}`)
        checkToInternalFunction({message, ws})
        router.parse(message)
            .then(res => {
                console.log(res)
                res.response ? ws.send(res.response) : null
                res.broadcast ? broadcast(res.broadcast) : null
            })
            .catch(e => console.error(e))
    })
})

// exports.broadcast = broadcast
// exports.wss = wss
module.exports = {
    broadcast
}
